rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to validate routine data structure
    function isValidRoutine() {
      return request.resource.data.keys().hasAll(['version', 'dayOfWeek', 'timeType', 'routines', 'anonId', 'createdAt', 'likes'])
        && request.resource.data.version is string
        && request.resource.data.dayOfWeek in ['월요일', '화요일', '수요일', '목요일', '금요일', '토요일', '일요일']
        && request.resource.data.timeType in ['아침', '점심', '저녁']
        && request.resource.data.routines is list
        && request.resource.data.routines.size() > 0
        && request.resource.data.routines.size() <= 20  // Max 20 routines per upload
        && request.resource.data.anonId is string
        && request.resource.data.likes is number
        && request.resource.data.likes >= 0;
    }

    // Helper function to check if all routines have valid structure
    function hasValidRoutineItems() {
      return request.resource.data.routines.hasAll(['name', 'order'])
        && request.resource.data.routines[0].name is string
        && request.resource.data.routines[0].order is number;
    }

    // Helper function for rate limiting (approximate)
    // Note: True rate limiting requires Cloud Functions
    function isNotSpamming() {
      // Allow if user is authenticated and has a valid UID
      return request.auth != null && request.auth.uid != null;
    }

    // Routines collection rules
    match /routines/{routineId} {
      // Anyone can read routines (public browsing)
      allow read: if true;

      // Create: Only authenticated users, with valid data structure
      allow create: if request.auth != null
                    && isValidRoutine()
                    && request.resource.data.anonId == request.auth.uid
                    && request.resource.data.likes == 0
                    && request.resource.data.size() < 10000;  // Max 10KB per document

      // Update: Only allow incrementing likes, nothing else
      allow update: if request.auth != null
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes'])
                    && request.resource.data.likes == resource.data.likes + 1
                    && request.resource.data.likes <= 1000000;  // Reasonable max likes

      // Delete: Only the creator can delete their own routines
      allow delete: if request.auth != null
                    && request.auth.uid == resource.data.anonId;
    }

    // Deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
